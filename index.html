<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentDate = new Date();
    let selectedCanteenId = 32; // Voreingestellt: Mensa Johanna

    // Format date as YYYY-MM-DD
    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    // Get dates for the current week (Montag bis Freitag, ohne Wochenende)
    function getWeekDates() {
      const dates = [];
      const startDate = new Date(currentDate);
      startDate.setDate(startDate.getDate() - startDate.getDay() + 1); // Montag der aktuellen Woche
      for (let i = 0; i < 5; i++) { // Nur Montag bis Freitag
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        dates.push(formatDate(date));
      }
      return dates;
    }

    // Fetch list of canteens
    async function fetchCanteens() {
      const url = `https://api.studentenwerk-dresden.de/openmensa/v2/canteens`;
      const response = await fetch(url);
      if (response.ok) {
        return response.json();
      } else {
        console.error("Error fetching canteens:", response.status);
        return [];
      }
    }

    // Populate the dropdown with canteens
    async function populateCanteens() {
      const canteens = await fetchCanteens();
      const dropdown = document.getElementById("canteenDropdown");

      dropdown.innerHTML = ""; // Clear existing options
      canteens.forEach((canteen) => {
        const option = document.createElement("option");
        option.value = canteen.id;
        option.textContent = canteen.name;
        if (canteen.id === 32) {
          option.selected = true; // Voreinstellung: Mensa Johanna
        }
        dropdown.appendChild(option);
      });

      // Set default selection
      renderWeek();
    }

    // Fetch meals for a given day and canteen
    async function fetchMeals(date) {
      if (!selectedCanteenId) return [];
      const url = `https://api.studentenwerk-dresden.de/openmensa/v2/canteens/${selectedCanteenId}/days/${date}/meals`;
      const response = await fetch(url);
      if (response.ok) {
        return response.json();
      } else {
        console.error("Error fetching meals:", response.status);
        return [];
      }
    }

    // Render meals dynamically for a specific day
    async function renderDay(date) {
      const meals = await fetchMeals(date);
      const dayContainer = document.createElement("div");
      dayContainer.classList.add("mb-8");

      // Day Header
      const dayHeader = document.createElement("h2");
      dayHeader.classList.add("text-2xl", "font-bold", "text-gray-800", "mb-4");
      dayHeader.textContent = new Date(date).toLocaleDateString('de-DE', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });

      dayContainer.appendChild(dayHeader);

      // Meals Grid
      const mealGrid = document.createElement("div");
      mealGrid.classList.add("flex", "flex-wrap", "gap-6");

      if (meals.length > 0) {
        meals.forEach((meal) => {
          const card = document.createElement("div");
          card.classList.add("bg-white", "rounded-lg", "shadow-lg", "p-4", "hover:shadow-xl", "transition-shadow", "duration-200", "w-72");

          card.innerHTML = `
            <div class="relative">
              <img src="https:${meal.image}" alt="${meal.name}" class="w-full h-40 rounded-lg object-cover">
              <span class="absolute top-2 right-2 bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-full">Rated</span>
            </div>
            <h3 class="font-bold text-gray-800 mt-4 text-lg">${meal.name}</h3>
            <div class="flex items-center space-x-4 text-gray-500 text-sm mt-2">
              <p>${meal.category}</p>
              <p>${meal.prices.Studierende.toFixed(2)} €</p>
            </div>
          `;
          mealGrid.appendChild(card);
        });
      } else {
        mealGrid.innerHTML = `<p class="text-gray-500 mt-2">Keine Gerichte verfügbar.</p>`;
      }

      dayContainer.appendChild(mealGrid);

      // Append to main container
      document.getElementById("weekContainer").appendChild(dayContainer);
    }

    // Render all days for the week
    async function renderWeek() {
      const weekContainer = document.getElementById("weekContainer");
      weekContainer.innerHTML = ""; // Clear previous content
      const dates = getWeekDates();
      for (const date of dates) {
        await renderDay(date);
      }
    }

    // Change selected canteen
    function changeCanteen(event) {
      selectedCanteenId = parseInt(event.target.value, 10);
      renderWeek();
    }

    // Navigate between weeks
    function changeWeek(weeks) {
      currentDate.setDate(currentDate.getDate() + weeks * 7);
      renderWeek();
    }

    // Initialize page
    document.addEventListener("DOMContentLoaded", () => {
      populateCanteens();
    });
  </script>
</head>
<body class="bg-gray-50 font-sans p-6">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-gray-800">Meal Planner</h1>
      <div class="mt-4">
        <label for="canteenDropdown" class="block text-gray-700 font-bold mb-2">Wähle eine Mensa:</label>
        <select id="canteenDropdown" class="w-full md:w-1/2 bg-white border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" onchange="changeCanteen(event)">
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      <div class="flex justify-center items-center space-x-4 mt-4">
        <button onclick="changeWeek(-1)" class="text-gray-500 hover:text-gray-700">&lt; Vorherige Woche</button>
        <button onclick="changeWeek(1)" class="text-gray-500 hover:text-gray-700">Nächste Woche &gt;</button>
      </div>
    </header>

    <!-- Week Container -->
    <div id="weekContainer">
      <!-- Days and Meals will be rendered dynamically here -->
    </div>
  </div>
</body>
</html>
