<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mensa Meals</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #FAFAFA;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background-color: #111827;
      color: #F9FAFB;
    }

    .meal-card {
      background: white;
      border-radius: 24px;
      transition: all 0.3s ease;
      border: 1px solid #F3F3F3;
      position: relative;
      z-index: 1;
    }

    .dark .meal-card {
      background: #1F2937;
      border-color: #374151;
    }

    .dark .text-gray-900 {
      color: #F3F4F6 !important;
      /* Force override Tailwind utilities */
    }

    .dark .text-gray-600,
    .dark .text-gray-700,
    .dark .text-gray-500 {
      color: #9CA3AF !important;
    }

    .dark .carousel-btn {
      background: #1F2937;
      border: 1px solid #374151;
      color: #F3F4F6;
    }

    .dark .bg-gray-200 {
      background-color: #374151;
      /* Button container */
    }

    .dark .bg-white {
      background-color: #1F2937;
      /* Buttons inactive */
    }

    .dark .bg-gray-900 {
      background-color: #111827;
      /* Buttons active */
      color: #F3F4F6;
    }

    .dark .filter-chip {
      background: #374151;
      color: #F3F4F6;
    }

    .dark select {
      color: #F3F4F6 !important;
    }

    .dark .tooltip {
      background: rgba(255, 255, 255, 0.95) !important;
      color: #111827 !important;
    }

    .dark .tooltip::after {
      border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent !important;
    }

    .dark .sold-out-badge {
      background: rgba(31, 41, 55, 0.95);
      /* Dark background for badge in dark mode */
      border-color: #7F1D1D;
    }

    .meal-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
    }

    .rating-badge {
      background: white;
      border-radius: 100px;
      padding: 6px 12px;
      font-size: 14px;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .health-score {
      display: flex;
      gap: 2px;
      margin-top: 12px;
    }

    .health-bar {
      width: 12px;
      height: 8px;
      background: #E5E7EB;
      border-radius: 4px;
    }

    .health-bar.active {
      background: #86EFAC;
    }

    .date-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .nav-btn {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #666;
    }

    .nav-btn:hover {
      color: #000;
    }

    .filter-chip {
      background: #F3F4F6;
      border-radius: 100px;
      padding: 8px 16px;
      font-size: 14px;
      color: #1F2937;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      max-width: 90%;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
    }

    .modal-content img {
      max-height: 80vh;
      width: auto;
      object-fit: contain;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .carousel-container {
      position: relative;
      overflow: hidden;
    }

    .carousel {
      display: flex;
      transition: transform 0.5s ease;
    }

    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      background: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .carousel-btn.prev {
      left: 16px;
    }

    .carousel-btn.next {
      right: 16px;
    }

    .carousel-container:hover .carousel-btn {
      opacity: 1;
    }

    .diet-badge {
      background: white;
      border-radius: 100px;
      padding: 6px 12px;
      font-size: 14px;
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tooltip-container {
      position: relative;
      z-index: 30;
    }

    .tooltip-trigger {
      position: relative;
      cursor: pointer;
    }

    .tooltip {
      position: absolute;
      left: 50%;
      bottom: 100%;
      transform: translateX(-50%);
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 8px;
      background: #111827;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
      pointer-events: none;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 4px;
      border-style: solid;
      border-color: #111827 transparent transparent transparent;
    }

    .tooltip-trigger:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-trigger:hover .tooltip.tooltip-left {
      transform: translateX(-10%);
    }

    .tooltip-trigger:hover .tooltip.tooltip-right {
      transform: translateX(-90%);
    }

    .allergens-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 16px;
      position: relative;
      z-index: 20;
    }

    /* Mobile Anpassungen */
    @media (max-width: 768px) {
      .tooltip {
        position: absolute;
        bottom: auto;
        top: -40px;
        /* Position √ºber dem Symbol */
        left: 50%;
        transform: translateX(-50%);
        white-space: normal;
        width: auto;
        max-width: 200px;
        text-align: center;
        z-index: 99999;
        /* Sehr hoher z-index */
        background: rgba(17, 24, 39, 0.95);
        /* Leicht transparent */
        backdrop-filter: blur(4px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        /* Pfeil nach unten */
        left: 50%;
        transform: translateX(-50%);
        border-width: 4px;
        border-style: solid;
        border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
      }

      .tooltip-container {
        position: relative;
        /* Zur√ºck zu relative */
      }

      .tooltip-trigger {
        position: relative;
        z-index: 1;
        padding: 6px;
      }

      /* Entferne alle anderen z-index Anpassungen */
      .allergens-container {
        position: relative;
      }
    }

    .sold-out {
      filter: grayscale(0.6) opacity(0.9);
      pointer-events: none;
    }

    .sold-out-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 50;
      overflow: hidden;
      border-radius: 24px;
      pointer-events: none;
    }

    .sold-out-badge {
      position: absolute;
      top: 32px;
      right: -60px;
      background: rgba(255, 255, 255, 0.95);
      color: #EF4444;
      width: 200px;
      text-align: center;
      padding: 8px 0;
      font-weight: 600;
      font-size: 0.9rem;
      transform: rotate(45deg);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid #FEE2E2;
      border-top: 1px solid #FEE2E2;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  </style>
  <script>
    let currentDate = new Date();
    let selectedCanteenId = 32; // Standard: Mensa Johanna
    let currentPriceRole = localStorage.getItem('priceRole') || 'Studierende'; // Standard: Studierendenpreis

    // Preis-Mapping f√ºr die API Keys
    const priceKeys = {
      'Studierende': 'Studierende',
      'Bedienstete': 'Bedienstete',
      'G√§ste': 'Andere' // Vermutung: API nutzt oft 'Andere' oder 'G√§ste'
    };

    // Aktive Filter laden
    let activeFilters = JSON.parse(localStorage.getItem('activeFilters') || '[]');

    // Hilfsfunktion zum Bereinigen von Namen (entfernt Allergen-Codes wie (A, A1, ...))
    function cleanMealName(name) {
      return name.replace(/\s*\([A-Z0-9,\s]+\)/g, '').trim();
    }

    // Formatieren des Datums als YYYY-MM-DD
    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    // Holen der Daten f√ºr die aktuelle Woche (Montag bis Freitag)
    function getWeekDates() {
      const dates = [];
      const startDate = new Date(currentDate);
      const dayOfWeek = startDate.getDay(); // 0 (Sonntag) bis 6 (Samstag)
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      startDate.setDate(startDate.getDate() + diffToMonday); // Setze auf Montag
      for (let i = 0; i < 5; i++) { // Nur Montag bis Freitag
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        dates.push(formatDate(date));
      }
      return dates;
    }

    // Abrufen der Gerichte f√ºr einen bestimmten Tag und eine bestimmte Mensa
    async function fetchMeals(date) {
      if (!selectedCanteenId || !date) {
        console.error('Ung√ºltige Parameter f√ºr fetchMeals');
        return [];
      }

      const url = `https://api.studentenwerk-dresden.de/openmensa/v2/canteens/${selectedCanteenId}/days/${date}/meals`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return Array.isArray(data) ? data : [];
      } catch (error) {
        console.error(`Fehler beim Abrufen der Gerichte f√ºr ${date}:`, error);
        return [];
      }
    }

    // Pr√ºfen der Verf√ºgbarkeit eines Gerichts
    async function checkMealAvailability(canteenId, date, mealId) {
      const url = `https://api.studentenwerk-dresden.de/openmensa/v2/canteens/${canteenId}/days/${date}/meals/${mealId}`;

      try {
        const response = await fetch(url);
        if (response.status === 404) {
          return false;
        }
        return true;
      } catch (error) {
        console.error(`Fehler beim Pr√ºfen der Verf√ºgbarkeit f√ºr ${mealId}:`, error);
        return true; // Im Fehlerfall als verf√ºgbar anzeigen
      }
    }

    // Erstellen einer Mahlzeitenkarte
    function createMealCard(meal, date) {
      const card = document.createElement("div");
      card.classList.add("meal-card");

      // Wrapper f√ºr den Inhalt erstellen, damit wir den Filter nur hierauf anwenden k√∂nnen
      const contentWrapper = document.createElement("div");
      contentWrapper.style.height = "100%";
      contentWrapper.style.display = "flex";
      contentWrapper.style.flexDirection = "column";

      const imageUrl = meal.image ? `https:${meal.image}` : 'placeholder-image-url.jpg';

      const priceKey = priceKeys[currentPriceRole] || currentPriceRole;
      let priceValue = meal.prices?.[priceKey];

      // Fallback: Wenn 'Andere/G√§ste' nicht da ist, nimm Bedienstete + Aufschlag (simuliert) oder zeige n/a
      // Dresden API hat oft nur Studierende/Bedienstete.
      if (!priceValue && currentPriceRole === 'G√§ste') {
        // Fallback Logik oder einfach Bedienstetenpreis anzeigen (oft identisch f√ºr Externe an Hochschulen?)
        // Wir lassen es erstmal leer wenn nicht vorhanden.
        if (meal.prices?.['Bedienstete']) {
          // Oft ist G√§ste = Bedienstete + X. Wir nehmen erstmal Bedienstete als Proxy wenn 'G√§ste' fehlt.
          priceValue = meal.prices['Bedienstete'];
        }
      }

      const price = priceValue ? `${priceValue.toFixed(2)} ‚Ç¨` : 'Preis k.A.';

      // Neue Symbole f√ºr vegan/vegetarisch mit Font Awesome
      const dietBadge = meal.notes?.includes("Men√º ist vegan")
        ? `<div class="diet-badge">
            <i class="fa-solid fa-leaf"></i>
            <span>Vegan</span>
          </div>`
        : meal.notes?.includes("Men√º ist vegetarisch")
          ? `<div class="diet-badge">
            <i class="fa-solid fa-seedling"></i>
            <span>Vegetarisch</span>
          </div>`
          : '';

      // √úberarbeitetes Symbol-Mapping mit Font Awesome Icons
      const symbolMap = {
        "Glutenhaltiges Getreide": {
          icon: `<i class="fa-solid fa-wheat-awn"></i>`,
          class: "text-amber-600"
        },
        "Weizen": {
          icon: `<i class="fa-solid fa-wheat-awn"></i>`,
          class: "text-amber-700"
        },
        "Eier": {
          icon: `<i class="fa-solid fa-egg"></i>`,
          class: "text-yellow-500"
        },
        "Milch": {
          icon: `<i class="fa-solid fa-cow"></i>`,
          class: "text-blue-400"
        },
        "Sellerie": {
          icon: `<i class="fa-solid fa-carrot"></i>`,
          class: "text-green-600"
        },
        "CO‚ÇÇ": {
          icon: `<i class="fa-solid fa-truck-fast"></i>`,
          class: "text-green-500"
        }
      };

      // Funktion zum Extrahieren des Hauptallergens
      function extractMainAllergen(note) {
        const allergenMatches = {
          "Glutenhaltiges Getreide": ["Glutenhaltiges Getreide", "Weizen", "Roggen", "Gerste"],
          "Milch": ["Milch", "Laktose"],
          "Eier": ["Eier"],
          "Sellerie": ["Sellerie"],
          "CO‚ÇÇ": ["CO‚ÇÇ"]
        };

        for (const [main, patterns] of Object.entries(allergenMatches)) {
          if (patterns.some(pattern => note.includes(pattern))) {
            return main;
          }
        }
        return null;
      }

      // HTML f√ºr die Allergene generieren
      const allergensHtml = meal.notes
        ?.map(note => {
          const mainAllergen = extractMainAllergen(note);
          if (mainAllergen && symbolMap[mainAllergen]) {
            return `
              <div class="tooltip-container">
                <div class="tooltip-trigger ${symbolMap[mainAllergen].class} bg-gray-100 rounded-full p-1.5 cursor-help">
                  ${symbolMap[mainAllergen].icon}
                  <div class="tooltip">
                    ${note}
                  </div>
                </div>
              </div>
            `;
          }
          return '';
        })
        .join('') || '';

      contentWrapper.innerHTML = `
        <div class="relative">
          <img src="${imageUrl}" 
               alt="${meal.name}" 
               class="w-full h-52 object-cover"
               onerror="this.src='placeholder-image-url.jpg'">
          <div class="absolute top-4 right-4">
            ${dietBadge}
          </div>
        </div>
        <div class="p-4">
          <div class="flex justify-between items-start gap-4 mb-2">
            <h3 class="font-bold text-gray-900 dark:text-white text-lg leading-tight cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors"
                onclick="showImageModal('${imageUrl}', '${meal.name.replace(/'/g, "\\'")}')">
              ${cleanMealName(meal.name)}
            </h3>
            <span class="font-bold text-indigo-600 dark:text-indigo-400 whitespace-nowrap bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-lg text-sm">
              ${price}
            </span>
          </div>
          <div class="allergens-container">
            ${allergensHtml}
          </div>
        </div>
      `;

      card.appendChild(contentWrapper);

      // Asynchron Verf√ºgbarkeit pr√ºfen
      checkMealAvailability(selectedCanteenId, date, meal.id).then(isAvailable => {
        if (!isAvailable) {
          // Klasse nur dem Wrapper hinzuf√ºgen!
          contentWrapper.classList.add('sold-out');

          const overlay = document.createElement('div');
          overlay.className = 'sold-out-overlay';
          overlay.innerHTML = `
            <div class="sold-out-badge">
              Ausverkauft
            </div>
          `;
          card.appendChild(overlay);
        }
      });

      // Tooltip Event Listener
      addTooltipListeners(card);

      // Modifiziere den Bildbereich
      card.querySelector('img').addEventListener('click', () => {
        showImageModal(imageUrl, meal.name);
      });

      return card;
    }

    // Neue Funktion f√ºr die Bildvorschau
    function showImageModal(imageUrl, title) {
      const modal = document.createElement('div');
      modal.classList.add('modal-backdrop');
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-close">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <img src="${imageUrl}" alt="${title}" class="w-full">
        </div>
      `;

      // Logik zum Schlie√üen
      const closeModal = () => {
        modal.remove();
        document.removeEventListener('keydown', onKeyDown);
      };

      const onKeyDown = (e) => {
        if (e.key === 'Escape') closeModal();
      };

      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.closest('.modal-close')) {
          closeModal();
        }
      });

      document.addEventListener('keydown', onKeyDown);
      document.body.appendChild(modal);
    }

    // √úberarbeitete renderDay Funktion f√ºr das Carousel
    async function renderDay(date) {
      if (!date) return;

      let meals = await fetchMeals(date);

      // Filter anwenden
      if (activeFilters.length > 0) {
        meals = meals.filter(meal => {
          const notes = (meal.notes || []).join(" ").toLowerCase();

          if (activeFilters.includes('vegan') && !notes.includes('vegan')) return false;
          if (activeFilters.includes('vegetarian') && !notes.includes('vegetarisch') && !notes.includes('vegan')) return false;
          if (activeFilters.includes('no-pork') && notes.includes('schwein')) return false;
          // Gluten: Pr√ºfe auf Allergen Code A oder Text. (Einfachheitshalber Text)
          // "Glutenhaltiges Getreide"
          if (activeFilters.includes('no-gluten') && (notes.includes('gluten') || notes.includes('weizen') || notes.includes('roggen'))) return false;

          return true;
        });
      }

      const dayContainer = document.createElement("div");
      dayContainer.classList.add("mb-12");
      // ID f√ºr das Scrollen setzen
      dayContainer.id = `day-${date}`;

      const dayHeader = document.createElement("h2");
      dayHeader.classList.add("text-2xl", "font-bold", "text-gray-900");

      const headerContainer = document.createElement("div");
      headerContainer.classList.add("flex", "items-center", "justify-between", "mb-6");

      try {
        dayHeader.textContent = new Date(date).toLocaleDateString('de-DE', {
          weekday: 'long'
        });
      } catch (error) {
        dayHeader.textContent = date;
        console.error('Fehler beim Formatieren des Datums:', error);
      }

      headerContainer.appendChild(dayHeader);
      dayContainer.appendChild(headerContainer);

      if (meals.length === 0) {
        const noMealsMessage = document.createElement("p");
        noMealsMessage.classList.add("text-gray-500", "text-center", "py-4");
        noMealsMessage.textContent = "Keine Gerichte verf√ºgbar f√ºr diesen Tag";
        dayContainer.appendChild(noMealsMessage);
        return dayContainer;
      }

      // Grid f√ºr Mobile (immer) und Desktop (wenn ‚â§ 3 Gerichte)
      const mealsGrid = document.createElement("div");
      const gridClasses = [
        "grid",
        "gap-6",
        "grid-cols-1",
        "md:grid-cols-2",
        "lg:grid-cols-3"
      ];

      // F√ºge die "md:hidden" Klasse nur hinzu, wenn mehr als 3 Gerichte vorhanden sind
      if (meals.length > 3) {
        gridClasses.push("md:hidden");
      }

      mealsGrid.classList.add(...gridClasses);

      meals.forEach(meal => {
        mealsGrid.appendChild(createMealCard(meal, date));
      });

      dayContainer.appendChild(mealsGrid);

      // Carousel nur f√ºr Desktop/Tablet wenn > 3 Gerichte
      if (meals.length > 3) {
        const carouselContainer = document.createElement('div');
        carouselContainer.classList.add('carousel-container', 'hidden', 'md:block');

        const carousel = document.createElement('div');
        carousel.classList.add('carousel');

        // Wir brauchen Klone am Anfang und am Ende f√ºr das unendliche Carousel
        // Sichtbar sind immer 3 items.
        // Array Struktur: [CloneEnd3, CloneEnd2, CloneEnd1, Real1, ..., RealN, CloneStart1, CloneStart2, CloneStart3]

        const itemsToShow = 3;
        // Klone der letzten 3 items f√ºr den Anfang
        const clonesStart = meals.slice(-itemsToShow).map(m => {
          const c = createMealCard(m, date);
          c.classList.add('w-1/3', 'flex-shrink-0');
          c.dataset.clone = "start";
          return c;
        });

        // Klone der ersten 3 items f√ºr das Ende
        const clonesEnd = meals.slice(0, itemsToShow).map(m => {
          const c = createMealCard(m, date);
          c.classList.add('w-1/3', 'flex-shrink-0');
          c.dataset.clone = "end";
          return c;
        });

        // Echte Items
        const realItems = meals.map(m => {
          const c = createMealCard(m, date);
          c.classList.add('w-1/3', 'flex-shrink-0');
          return c;
        });

        // Alle Items zusammenf√ºgen
        const allItems = [...clonesStart, ...realItems, ...clonesEnd];

        allItems.forEach(card => carousel.appendChild(card));

        const prevBtn = document.createElement('button');
        prevBtn.classList.add('carousel-btn', 'prev');
        prevBtn.innerHTML = `
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        `;

        const nextBtn = document.createElement('button');
        nextBtn.classList.add('carousel-btn', 'next');
        nextBtn.innerHTML = `
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        `;

        // State f√ºr Carousel
        let currentIndex = itemsToShow; // Start beim ersten echten Item (nach den Start-Klonen)
        const slideWidth = 100 / itemsToShow; // 33.333%
        let isAnimating = false;

        // Initiale Position setzen (ohne Transition)
        carousel.style.transition = 'none';
        carousel.style.transform = `translateX(-${currentIndex * slideWidth}%)`;

        function updateCarousel(direction) {
          if (isAnimating) return;
          isAnimating = true;

          carousel.style.transition = 'transform 0.5s ease';

          if (direction === 'next') {
            currentIndex++;
          } else {
            currentIndex--;
          }

          carousel.style.transform = `translateX(-${currentIndex * slideWidth}%)`;
        }

        // Transition End Listener f√ºr den "Silent Jump"
        carousel.addEventListener('transitionend', () => {
          isAnimating = false;

          // Wenn wir ans Ende gescrollt haben (auf die End-Klone)
          if (currentIndex >= realItems.length + itemsToShow) {
            carousel.style.transition = 'none';
            currentIndex = itemsToShow; // Zur√ºck zum Start der echten Items
            carousel.style.transform = `translateX(-${currentIndex * slideWidth}%)`;
          }

          // Wenn wir zum Anfang gescrollt haben (auf die Start-Klone)
          if (currentIndex < itemsToShow) {
            carousel.style.transition = 'none';
            // Wenn currentIndex wird itemsToShow - 1 (also 2), dann sind wir auf letztem Start-Klon.
            // Das entspricht dem letzten echten Item.
            // Der Klon bei Index 2 (letzter StartKlon) ist eine Kopie vom letzten echten Item.
            // Das letzte echte Item ist bei Index: itemsToShow + realItems.length - 1.
            // Wenn wir von currentIndex (z.B. 2) zu diesem springen wollen,
            // ist der neue Index: currentIndex + realItems.length.
            // Bsp: Length=5. ItemsToShow=3.
            // Indices: 0,1,2 (Klone) | 3,4,5,6,7 (Echt) | 8,9,10 (Klone).
            // Wir sind bei 2. Das ist Clone von 7.
            // Ziel ist 7.
            // Formel: currentIndex (2) + realItems.length (5) = 7.

            currentIndex = currentIndex + realItems.length;
            carousel.style.transform = `translateX(-${currentIndex * slideWidth}%)`;
          }
        });

        prevBtn.addEventListener('click', () => updateCarousel('prev'));
        nextBtn.addEventListener('click', () => updateCarousel('next'));

        carouselContainer.appendChild(prevBtn);
        carouselContainer.appendChild(carousel);
        carouselContainer.appendChild(nextBtn);
        dayContainer.appendChild(carouselContainer);
      }

      return dayContainer;
    }

    // Rendern der gesamten Woche
    async function renderWeek() {
      const weekContainer = document.getElementById("weekContainer");
      weekContainer.innerHTML = ""; // Vorherigen Inhalt l√∂schen
      const dates = getWeekDates();
      for (const date of dates) {
        const dayElement = await renderDay(date);
        if (dayElement) {
          weekContainer.appendChild(dayElement);
        }
      }

      // Aktualisiere den Datumsbereich im Header
      updateDateRange(dates[0], dates[dates.length - 1]);
    }

    // Neue Funktion f√ºr die Datumsanzeige
    function updateDateRange(startDate, endDate) {
      const dateRangeElement = document.getElementById("currentDateRange");
      const start = new Date(startDate);
      const end = new Date(endDate);

      const formatOptions = { day: 'numeric', month: 'short' };
      const startStr = start.toLocaleDateString('de-DE', formatOptions);
      const endStr = end.toLocaleDateString('de-DE', formatOptions);

      dateRangeElement.textContent = `${startStr} - ${endStr}`;
    }

    // Neue Funktionen f√ºr die Navigation
    function previousWeek() {
      currentDate.setDate(currentDate.getDate() - 7);
      renderWeek();
    }

    function nextWeek() {
      currentDate.setDate(currentDate.getDate() + 7);
      renderWeek();
    }

    // Bef√ºllen des Dropdowns mit Mensen
    async function populateCanteens() {
      const url = `https://api.studentenwerk-dresden.de/openmensa/v2/canteens`;
      try {
        const response = await fetch(url);
        const dropdown = document.getElementById("canteenDropdown");
        dropdown.innerHTML = ""; // Vorhandene Optionen l√∂schen

        if (response.ok) {
          const canteens = await response.json();
          canteens.forEach((canteen) => {
            const option = document.createElement("option");
            option.value = canteen.id;
            option.textContent = canteen.name;
            if (canteen.id === selectedCanteenId) {
              option.selected = true; // Standardm√§√üig Mensa Johanna ausw√§hlen
            }
            dropdown.appendChild(option);
          });
        } else {
          console.error("Fehler beim Abrufen der Mensen:", response.status);
          dropdown.innerHTML = "<option>Keine Mensen verf√ºgbar</option>";
        }
      } catch (error) {
        console.error("Fehler beim Abrufen der Mensen:", error);
        const dropdown = document.getElementById("canteenDropdown");
        dropdown.innerHTML = "<option>Fehler beim Laden</option>";
      }
    }


    // √Ñndern der ausgew√§hlten Mensa
    function changeCanteen(event) {
      selectedCanteenId = parseInt(event.target.value, 10);
      renderWeek();
    }

    // √Ñndern der Preisgruppe
    function changePriceRole(role) {
      currentPriceRole = role;
      localStorage.setItem('priceRole', role);

      // Update Button Styles
      document.querySelectorAll('.price-btn').forEach(btn => {
        if (btn.dataset.role === role) {
          // Dark Mode aware classes handling via CSS overrides/specifics or utility updates
          // Wir nutzen einfache Logik, da global dark class auf body ist
          btn.classList.add('active-role');
        } else {
          btn.classList.remove('active-role');
        }
      });

      // Manuelles class swapping f√ºr buttons hier ist m√ºhsam mit Dark Mode. 
      // Besser: wir entfernen die harten classes und nutzen CSS selector basierend auf 'active-role'.
      // Aber okay, wir passen einfach die Klassen an f√ºr "active" Zustand.

      document.querySelectorAll('.price-btn').forEach(btn => {
        // Reset base
        btn.className = "price-btn px-4 py-1.5 rounded-md text-sm font-medium transition-colors";
        if (btn.dataset.role === role) {
          btn.classList.add('bg-gray-900', 'text-white');
        } else {
          btn.classList.add('bg-white', 'text-gray-700');
        }
      });

      renderWeek();
    }

    // Dark Mode Logic
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      document.body.classList.toggle('dark'); // Fallback/Support
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeToggle();
    }

    function updateDarkModeIcon() {
      const isDark = document.documentElement.classList.contains('dark');
      const icon = document.getElementById('darkModeIcon');
      if (icon) {
        icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      }
    }

    function initDarkMode() {
      const saved = localStorage.getItem('darkMode') === 'true';
      if (saved) {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');
      }
      updateDarkModeToggle();
    }

    // Toggle Filter
    function toggleFilter(filter) {
      if (activeFilters.includes(filter)) {
        activeFilters = activeFilters.filter(f => f !== filter);
      } else {
        // Logik: Vegan impliziert Vegetarian
        activeFilters.push(filter);
      }
      localStorage.setItem('activeFilters', JSON.stringify(activeFilters));
      renderFilters();
      renderWeek();
    }

    // Filter UI rendern
    function renderFilters() {
      const container = document.getElementById('filterContainer');
      const filters = [
        { id: 'vegan', label: 'Vegan', icon: 'fa-leaf' },
        { id: 'vegetarian', label: 'Vegetarisch', icon: 'fa-seedling' },
        { id: 'no-pork', label: 'Kein Schwein', icon: 'fa-ban' }, // Icons ggf. anpassen
        { id: 'no-gluten', label: 'Glutenfrei', icon: 'fa-wheat-awn-circle-exclamation' }
      ];

      container.innerHTML = filters.map(f => {
        const isActive = activeFilters.includes(f.id);
        const activeClass = isActive ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 border-indigo-200 dark:border-indigo-800' : 'bg-gray-50 text-gray-600 dark:bg-gray-700/50 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600/50';
        return `
          <button onclick="toggleFilter('${f.id}')"
                  class="${activeClass} border px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center gap-2">
            <i class="fa-solid ${f.icon}"></i>
            ${f.label}
          </button>
        `;
      }).join('');
    }

    // Share Funktion
    async function shareDay(date, meals) {
      const dateStr = new Date(date).toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit' });
      let text = `üìÖ Mensa ${dateStr}\n\n`;

      if (meals.length === 0) {
        text += "Keine Gerichte verf√ºgbar.";
      } else {
        meals.forEach(meal => {
          // Preis ermitteln
          const priceKey = priceKeys[currentPriceRole] || currentPriceRole;
          const price = meal.prices?.[priceKey] ? `${meal.prices[priceKey].toFixed(2)}‚Ç¨` : 'N/A';

          // Status pr√ºfen (f√ºr Text markieren?)
          // Wir k√∂nnten checkMealAvailability hier nicht synchron nutzen.
          // Wir lassen Verf√ºgbarkeit im Text weg oder rufen sie parallel ab (zu aufwendig f√ºr Share Button).
          // Einfach Gerichte auflisten.

          text += `üçΩÔ∏è ${cleanMealName(meal.name)} (${price})\n`;
        });
      }

      text += `\nüîó https://www.studentenwerk-dresden.de/mensen/speiseplan/`;

      if (navigator.share) {
        try {
          await navigator.share({
            title: `Mensa Speiseplan ${dateStr}`,
            text: text
          });
        } catch (err) {
          console.log('Error sharing:', err);
        }
      } else {
        // Fallback Clipboard
        try {
          await navigator.clipboard.writeText(text);
          alert("Speiseplan in die Zwischenablage kopiert!");
        } catch (err) {
          console.error('Failed to copy!', err);
          alert("Konnte nicht kopieren.");
        }
      }
    }

    // Modifiziere die Event Listener f√ºr die Tooltips
    function addTooltipListeners(card) {
      card.querySelectorAll('.tooltip-trigger').forEach(trigger => {
        const tooltip = trigger.querySelector('.tooltip');

        // Pr√ºfe ob es ein Touch-Ger√§t ist
        if ('ontouchstart' in window) {
          // Touch Events
          trigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            // Schlie√üe alle anderen offenen Tooltips
            document.querySelectorAll('.tooltip').forEach(t => {
              if (t !== tooltip) {
                t.style.visibility = 'hidden';
                t.style.opacity = '0';
              }
            });

            // Toggle aktuellen Tooltip
            if (tooltip.style.visibility === 'visible') {
              tooltip.style.visibility = 'hidden';
              tooltip.style.opacity = '0';
            } else {
              tooltip.style.visibility = 'visible';
              tooltip.style.opacity = '1';
            }
          });

          // Schlie√üe Tooltip wenn woanders hingeklickt wird
          document.addEventListener('click', (e) => {
            if (!trigger.contains(e.target)) {
              tooltip.style.visibility = 'hidden';
              tooltip.style.opacity = '0';
            }
          });
        } else {
          // Desktop Hover Events
          trigger.addEventListener('mouseenter', () => {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
          });

          trigger.addEventListener('mouseleave', () => {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
          });
        }
      });
    }

    // Initialisierung nach dem Laden des Dokuments
    document.addEventListener("DOMContentLoaded", () => {
      initDarkMode();
      populateCanteens();
      // Initiale Preisgruppen-Anzeige setzen
      changePriceRole(currentPriceRole);
      renderFilters();

      document.getElementById('prevWeekBtn').addEventListener('click', previousWeek);
      document.getElementById('nextWeekBtn').addEventListener('click', nextWeek);
    });
  </script>
</head>

<body class="p-6 md:p-8">
  <div class="max-w-7xl mx-auto">
    <header class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-8">Mensa Meals</h1>
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-8">
        <div class="flex items-center gap-4">
          <div class="filter-chip bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
            <i class="fa-solid fa-school-flag text-gray-600 dark:text-gray-300"></i>
            <select id="canteenDropdown"
              class="bg-transparent border-none focus:outline-none focus:ring-0 text-gray-700 dark:text-gray-200 pr-8"
              onchange="changeCanteen(event)">
            </select>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <!-- Date Nav -->
          <div
            class="date-nav flex items-center gap-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full px-2 py-1 shadow-sm">
            <button id="prevWeekBtn"
              class="nav-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h2 id="currentDateRange"
              class="text-base font-semibold text-gray-800 dark:text-white min-w-[120px] text-center">
              Lade Woche...
            </h2>
            <button id="nextWeekBtn"
              class="nav-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>

          <!-- Share Button -->
          <button onclick="openShareModal()"
            class="bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 p-3 rounded-full hover:shadow-lg transition-all border border-gray-100 dark:border-gray-700 hover:text-indigo-600 dark:hover:text-indigo-400">
            <i class="fa-solid fa-share-nodes"></i>
          </button>

          <!-- Calendar Button -->
          <button onclick="openCalendarModal()"
            class="bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 p-3 rounded-full hover:shadow-lg transition-all border border-gray-100 dark:border-gray-700 hover:text-indigo-600 dark:hover:text-indigo-400">
            <i class="fa-regular fa-calendar-days"></i>
          </button>

          <!-- Settings Button -->
          <button onclick="openSettings()"
            class="bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 p-3 rounded-full hover:shadow-lg transition-all border border-gray-100 dark:border-gray-700 hover:text-indigo-600 dark:hover:text-indigo-400">
            <i class="fa-solid fa-sliders"></i>
          </button>
        </div>
      </div>
    </header>

    <div id="weekContainer">
      <!-- Tage und Gerichte werden hier dynamisch gerendert -->
    </div>


    <footer class="mt-16 py-8 border-t border-gray-100 dark:border-gray-800 text-center">
      <a href="https://github.com/xNycrofox/mensa-meal-overview" target="_blank" rel="noopener noreferrer"
        class="inline-flex items-center gap-2 text-gray-400 hover:text-gray-900 dark:text-gray-500 dark:hover:text-gray-300 transition-colors group">
        <i class="fa-brands fa-github text-lg group-hover:scale-110 transition-transform"></i>
        <span class="text-sm font-medium">Mitentwickeln auf GitHub</span>
      </a>
    </footer>
  </div>
  <!-- Settings Modal -->
  <div id="settingsModal"
    class="modal-backdrop hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform scale-95 transition-transform duration-300"
      id="settingsModalContent">
      <div
        class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50 backdrop-blur-sm">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Einstellungen</h3>
        <button onclick="closeSettingsModal()"
          class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6 space-y-8">

        <!-- Price Section -->
        <div class="space-y-3">
          <label
            class="block text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Preise</label>
          <div class="flex bg-gray-100 dark:bg-gray-700 p-1.5 rounded-xl">
            <button class="price-btn flex-1 py-2 rounded-lg text-sm font-medium transition-all shadow-sm"
              data-role="Studierende" onclick="changePriceRole('Studierende')">Studis</button>
            <button class="price-btn flex-1 py-2 rounded-lg text-sm font-medium transition-all shadow-sm"
              data-role="Bedienstete" onclick="changePriceRole('Bedienstete')">Mitarbeitende</button>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="space-y-3">
          <label
            class="block text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter</label>
          <div id="filterContainer" class="flex flex-wrap gap-2">
            <!-- Wird dynamisch bef√ºllt -->
          </div>
        </div>

        <!-- Appearance Section -->
        <div class="space-y-3">
          <label
            class="block text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Erscheinungsbild</label>
          <div
            class="flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                <i id="darkModeIcon" class="fa-solid fa-moon"></i>
              </div>
              <span class="text-gray-700 dark:text-gray-200 font-medium">Dark Mode</span>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="darkModeToggle" class="sr-only peer" onchange="toggleDarkMode()">
              <div
                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600">
              </div>
            </label>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal"
    class="modal-backdrop hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform scale-95 transition-transform duration-300"
      id="shareModalContent">
      <div
        class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50 backdrop-blur-sm">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">App Teilen</h3>
        <button onclick="closeShareModal()"
          class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6 space-y-4">
        <p class="text-gray-600 dark:text-gray-300 text-sm">Teile diesen Link mit deinen Freunden, damit sie auch sehen,
          was es heute in der Mensa gibt!</p>

        <div class="relative">
          <input type="text" id="shareLinkInput" readonly
            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
            value="https://mensa-meals.com">
        </div>

        <button id="copyLinkBtn" onclick="copyShareLink()"
          class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-indigo-600 dark:hover:bg-indigo-700 focus:outline-none dark:focus:ring-indigo-800 transition-all flex items-center justify-center gap-2">
          <span>üìã</span> Link kopieren
        </button>
      </div>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal"
    class="modal-backdrop hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform scale-95 transition-transform duration-300"
      id="calendarModalContent">
      <div
        class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50 backdrop-blur-sm">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Kalender Abo</h3>
        <button onclick="closeCalendarModal()"
          class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6 space-y-4">
        <p class="text-gray-600 dark:text-gray-300 text-sm">Abonniere den Speiseplan in deinem Kalender (Google,
          Outlook, etc.), um immer zu wissen, was es gibt!</p>

        <div class="relative">
          <input type="text" id="calendarLinkInput" readonly
            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
            value="https://raw.githubusercontent.com/xNycrofox/mensa-meal-overview/main/mensa.ics">
        </div>

        <button id="copyCalendarBtn" onclick="copyCalendarLink()"
          class="w-full text-indigo-600 bg-indigo-50 hover:bg-indigo-100 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-gray-700 dark:text-indigo-400 dark:hover:bg-gray-600 focus:outline-none dark:focus:ring-gray-600 transition-all flex items-center justify-center gap-2">
          <span>üîó</span> URL f√ºr Kalender kopieren
        </button>
      </div>
    </div>
  </div>

  <script>
    // Settings Modal Logic
    const settingsModal = document.getElementById('settingsModal');
    const settingsModalContent = document.getElementById('settingsModalContent');

    function openSettings() {
      settingsModal.classList.remove('hidden');
      // Force reflow
      void settingsModal.offsetWidth;
      settingsModal.classList.remove('opacity-0');
      settingsModalContent.classList.remove('scale-95');
      settingsModalContent.classList.add('scale-100');
    }

    function closeSettingsModal() {
      settingsModal.classList.add('opacity-0');
      settingsModalContent.classList.remove('scale-100');
      settingsModalContent.classList.add('scale-95');
      setTimeout(() => {
        settingsModal.classList.add('hidden');
      }, 300);
    }

    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) closeSettingsModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!settingsModal.classList.contains('hidden')) closeSettingsModal();
        if (!shareModal.classList.contains('hidden')) closeShareModal();
        if (!calendarModal.classList.contains('hidden')) closeCalendarModal();
      }
    });

    // Dark Mode Sync for Toggle Switch
    function updateDarkModeToggle() {
      const isDark = document.documentElement.classList.contains('dark');
      const toggle = document.getElementById('darkModeToggle');
      if (toggle) toggle.checked = isDark;
      updateDarkModeIcon();
    }

    // Share Modal Logic
    const shareModal = document.getElementById('shareModal');
    const shareModalContent = document.getElementById('shareModalContent');

    function openShareModal() {
      // Setze aktuelle URL
      document.getElementById('shareLinkInput').value = window.location.href;

      shareModal.classList.remove('hidden');
      void shareModal.offsetWidth;
      shareModal.classList.remove('opacity-0');
      shareModalContent.classList.remove('scale-95');
      shareModalContent.classList.add('scale-100');
    }

    function closeShareModal() {
      shareModal.classList.add('opacity-0');
      shareModalContent.classList.remove('scale-100');
      shareModalContent.classList.add('scale-95');
      setTimeout(() => {
        shareModal.classList.add('hidden');
      }, 300);
    }

    shareModal.addEventListener('click', (e) => {
      if (e.target === shareModal) closeShareModal();
    });

    function copyShareLink() {
      const copyText = document.getElementById("shareLinkInput");
      const btn = document.getElementById("copyLinkBtn");

      copyText.select();
      copyText.setSelectionRange(0, 99999);

      navigator.clipboard.writeText(copyText.value).then(() => {
        // Feedback Button
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<span>‚úÖ</span> Kopiert!`;
        btn.classList.add('bg-green-600', 'hover:bg-green-700', 'dark:bg-green-600', 'dark:hover:bg-green-700');
        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'dark:bg-indigo-600', 'dark:hover:bg-indigo-700');

        setTimeout(() => {
          btn.innerHTML = originalContent;
          btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'dark:bg-green-600', 'dark:hover:bg-green-700');
          btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'dark:bg-indigo-600', 'dark:hover:bg-indigo-700');
          closeShareModal();
        }, 1500);
      }).catch(err => {
        console.error('Copy failed', err);
      });
    }

    // Calendar Modal Logic
    const calendarModal = document.getElementById('calendarModal');
    const calendarModalContent = document.getElementById('calendarModalContent');

    function openCalendarModal() {
      calendarModal.classList.remove('hidden');
      void calendarModal.offsetWidth;
      calendarModal.classList.remove('opacity-0');
      calendarModalContent.classList.remove('scale-95');
      calendarModalContent.classList.add('scale-100');
    }

    function closeCalendarModal() {
      calendarModal.classList.add('opacity-0');
      calendarModalContent.classList.remove('scale-100');
      calendarModalContent.classList.add('scale-95');
      setTimeout(() => {
        calendarModal.classList.add('hidden');
      }, 300);
    }

    calendarModal.addEventListener('click', (e) => {
      if (e.target === calendarModal) closeCalendarModal();
    });

    function copyCalendarLink() {
      const copyText = document.getElementById("calendarLinkInput");
      const btn = document.getElementById("copyCalendarBtn");

      copyText.select();
      copyText.setSelectionRange(0, 99999);

      navigator.clipboard.writeText(copyText.value).then(() => {
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<span>‚úÖ</span> URL kopiert!`;

        setTimeout(() => {
          btn.innerHTML = originalContent;
        }, 1500);
      });
    }
  </script>
</body>

</html>